#!/bin/sh
. generalfuncs
. racffuncs
while getopts ":vh?d:p:" opt; do
	case ${opt} in
		p )
                   	browserCertPW=${OPTARG}
                        ;;
		d )
                   	browserCertDir=${OPTARG}
                        if [ -d "${browserCertDir}" ]; then
                                echo "${browserCertDir} is not a valid directory." >&2
                                Syntax
                        fi
                        ;;
		v )
                   	verbose=1
                        opts="${opts} -v"
			;;
		\?)
			if [ ${OPTARG} != "?" ] && [ ${OPTARG} != "h" ]; then
				echo "Unknown Option: ${OPTARG}" >&2
			fi
			Syntax
			exit 4
			;;
	esac
done
shift $(expr $OPTIND - 1 )

if [ $# -lt 4 ]; then
	echo "Syntax: $0 <cert-name> <cert-owner> <cert-label> <cert-auth-label> [<title>]" >&2
	echo "  where <cert-name> is the common name of the certificate" >&2
	echo "  where <cert-owner> is the ID of the certificate owner" >&2
	echo "  where <cert-label> is the certificate label to use" >&2
	echo "  where <cert-auth-label> is the signing certificate label to use" >&2
	echo "  and <title> is the optional certificate title" >&2
	echo "Example:" >&2
	echo "To create a certificate with name zosmfcc, owned by ibmuser, label 'zosmf client certificate', auth label ADCDCA, and title 'z/OSMF Client Certificate'" >&2
	echo "  $0 zosmfcc ibmuser 'zosmf client certificate' 'ADCDCA' 'z/OSMF Client Certificate'" >&2
	echo "To delete this certificate:" >&2
	echo "  tsocmd \"racdcert delete (label('zosmf client certificate'))\"" >&2
	exit 4
fi

set +x

export NAME="$1"
export OWNER="$2"
export LABEL="$3"
export AUTH_LABEL="$4"

if [ $# -gt 4 ]; then 
	export TITLE="$5"
else
	export TITLE='Generic Certificate'
fi

export X509DN_T="${TITLE}"
export X509DN_OU='Markham Labs'
export X509DN_O='IBM'
export X509DN_L='Markham'
export X509DN_SP='ON'
export X509DN_C='CAN'
export X509DN_NOTAFTER='DATE(2021-12-31)'
export X509DN_NOTBEFORE='TIME(00:00:00)'

mydir=`abspath $0`

subjectsdn=`racfSubjectsDN "${NAME}"`
issueTSO "RACDCERT ID(${OWNER}) GENCERT ${subjectsdn} SIZE(2048) WITHLABEL('${LABEL}') SIGNWITH(CERTAUTH LABEL('${AUTH_LABEL}'))"
chk $? "Unable to create certificate ${OWNER} with label ${LABEL} and signing certificate label ${AUTH_LABEL}"

issueTSO "RACDCERT ID(${OWNER}) ALTER(LABEL('${LABEL}')) TRUST"
chk $? "Unable to mark certificate with label ${LABEL} as trusted"

racfRefreshClasses "DIGTCERT"
chk $? "Unable to refresh DIGTCERT class"
