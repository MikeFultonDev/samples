#!/bin/sh
#
# Get (or Set) a z/OSMF System Variable
# See https://tech.mikefulton.ca/ZOSMFSystemVariableAPIs for details on the underlying z/OSMF APIs
# This example uses httpsget. See Syntax for details
#
Syntax() {
	echo "$0 [-v] <var>[=<val>]" >&2
	echo "  Where <var> is the z/OSMF System Varaible to get or set" >&2
	echo "  If <val> is specified, <var> will be set to <val>" >&2
	echo "  If <val> is not specified, the current value of <var> will be written to stdout" >&2
	echo "  If -v is specified, verbose network tracing will be written to stderr" >&2
	echo "Example: Set the variable myappport to 2020" >&2
	echo " $0 myappport=2020" >&2
	echo "Example: Print the value of myappport" >&2
	echo " $0 myappport" >&2
	echo "Note:" >&2
	echo "You need httpsget to run this code. You can get the latest version from: https://github.com/zospm/zospm/blob/main/bin/httpsget" >&2
}

zosmfport() {
	zosmfnetstat=`tsocmd netstat 2>/dev/null | grep IZUSVR | grep ".*Listen"`
	rc=$?
	if [ $rc -gt 0 ]; then
		echo "Unable to determine port z/OSMF (IZUSVR*) is listening on. Is z/OSMF started on this system?" >&2
		Syntax
	fi
 	zosmfqualifiedport=`echo "${zosmfnetstat}" | awk '{ print $4 }'`
	zosmfport=${zosmfqualifiedport##*.}
	echo ${zosmfport}
}

opts=""         	
verbose=0
while getopts ":v" opt; do
	case ${opt} in
		v )
			verbose=1
			opts="${opts} -v"
			;;
		\?)         
			if [ ${OPTARG} != "?" ]; then
				echo "Unknown Option: ${OPTARG}" >&2
			fi                
			Syntax
			exit 4
			;;        
	esac  	
done    	
shift $(expr $OPTIND - 1 )

if [ $# -eq 0 ]; then
  Syntax
  exit 4
fi

httpsgetversion=`httpsget -V 2>/dev/null`
rc=$?
if [ $rc -eq 127 ]; then
	echo "httpsget not found." >&2
	Syntax
	exit 16
fi
if [ $rc -gt 0 ]; then
	echo "You have an old version of httpsget. You need at least Version 1.0.1" >&2
	Syntax
	exit 8
fi

sysname=`sysvar SYSNAME`
sysplexname=`sysvar SYSPLEX`
zosmfport=`zosmfport`

arg="$1"
sysval="${arg#*=}"
if [ "${sysval}" = "$1" ]; then
	sysvar="$1"
	sysval=""
else
	sysvar="${arg%%=*}"
fi

if [ "${USERNAME}" != '' ] && [ "${PASSWORD}" != '' ]; then
	opts="-u ${USERNAME}:${PASSWORD}"
else
	opts='-l zosmfcert -r IBMUSER/ZOSMF'
fi
if [ ${verbose} -gt 0 ]; then
	file="$RANDOM.$$.https.out"
	if [ "$TMP" != '' ]; then
		verboseFile="${TMP}/${file}"
	else
		verboseFile="/tmp/${file}"	
	fi
	opts="${opts} -v ${verboseFile}"
else
	verboseFile=''
fi

if [ "${sysval}" = '' ]; then
	payload=`httpsget ${opts} "https://127.0.0.1:${zosmfport}/zosmf/variables/rest/1.0/systems/${sysplexname}.${sysname}" | iconv -f ISO8859-1 -t IBM-1047`
	rc=$?
	if [ $rc -eq 0 ]; then
		payload=`echo "${payload}" | readsysvar "${sysvar}"`
		rc=$?
	fi
	if [ $rc -eq 0 ]; then
		echo "${payload}"
	fi
else
	request=`echo "{\"system-variable-list\":[{\"name\":\"${sysvar}\",\"value\":\"${sysval}\",\"description\":\"\"}]}'" | iconv -f IBM-1047 -t ISO8859-1`
	payload=`echo ${request} | httpspost ${opts} "https://127.0.0.1:${zosmfport}/zosmf/variables/rest/1.0/systems/${sysplexname}.${sysname}" | iconv -f ISO8859-1 -t IBM-1047`
	rc=$?
fi
if [ ${verbose} -gt 0 ]; then
	cat "${verboseFile}" >&2
	rm -f "${verboseFile}"
fi
exit $rc
